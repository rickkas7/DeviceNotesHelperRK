<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DeviceNotesHelperRK: DeviceNotesHelperRK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DeviceNotesHelperRK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">DeviceNotesHelperRK </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a> <em>Utilities for using device notes from Particle devices</em></p>
<p>You should really <a href="https://docs.particle.io/getting-started/logic-ledger/ledger/">Ledger</a> which is built into Device OS and the Particle platform and is a much better way to store configuration settings.</p>
<hr  />
<p>When you open a device in the <a href="https://console.particle.io">console</a> there's a section on the right for notes.</p>
<div class="image">
<img src="notes-empty.png" alt=""/>
<div class="caption">
Empty Note</div></div>
    <p>You can edit them using the <b>Edit</b> button and typically you use a textual description.</p>
<div class="image">
<img src="notes-typical.png" alt=""/>
<div class="caption">
Typical Note</div></div>
    <p>However, you don't have to. One interesting technique is to store structured data in JSON there. You can set or get the data from the device itself (using webhooks) and also get or set the data using the Particle Cloud API.</p>
<div class="image">
<img src="notes-json.png" alt=""/>
<div class="caption">
JSON Note</div></div>
    <p>This repository contains a library for Particle devices and some sample code for using this from other places.</p>
<p>Some reasons you might want to do this:</p>
<ul>
<li>Have per-device settings stored in the cloud but downloaded to the device, allowing a single firmware binary to be used.</li>
<li>Provide a way for a device to store a small amount of data in the cloud, without requiring a 3rd-party service or server.</li>
</ul>
<p>Using functions and variables is usually easier, and if you have your own server, monitoring published events using webhooks or the Server-Sent-Events stream (SSE) is generally more efficient. However, in some limited use-cases, this technique is kind of handy!</p>
<h1>Get an access token</h1>
<p>The curl and node.js examples assume an environment variable <code>AUTH_TOKEN</code> that contains a valid Particle authentication token. You can create one using the API or get on from the <a href="https://build.particle.io">Web IDE</a> Settings (gear icon).</p>
<div class="image">
<img src="user_token.png" alt=""/>
<div class="caption">
Auth Token</div></div>
    <p>In this case, the token is ab142050967cff79dc6586c82193978b3a62cab9.</p>
<p>For Mac and Linux:</p>
<div class="fragment"><div class="line">export AUTH_TOKEN=ab142050967cff79dc6586c82193978b3a62cab9</div>
</div><!-- fragment --><p>For Windows:</p>
<div class="fragment"><div class="line">set AUTH_TOKEN=ab142050967cff79dc6586c82193978b3a62cab9</div>
</div><!-- fragment --><p>You'll also need this access token to paste into your webhook.</p>
<h1>Create the webhooks</h1>
<p>This technique requires two webhooks, one to get data and one to set it. The easiest way is to edit the access_token, then upload it from the Particle CLI.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;event&quot;: &quot;DeviceNotesGet&quot;,</div>
<div class="line">    &quot;url&quot;: &quot;https://api.particle.io/v1/devices/{{PARTICLE_DEVICE_ID}}&quot;,</div>
<div class="line">    &quot;query&quot;: {</div>
<div class="line">        &quot;access_token&quot;: &quot;ab142050967cff79dc6586c82193978b3a62cab9&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;requestType&quot;: &quot;GET&quot;,</div>
<div class="line">    &quot;responseTopic&quot;: &quot;{{{PARTICLE_DEVICE_ID}}}/DeviceNotesResponse&quot;,</div>
<div class="line">    &quot;responseTemplate&quot;: &quot;{{{notes}}}&quot;,</div>
<div class="line">    &quot;mydevices&quot;: true,</div>
<div class="line">    &quot;noDefaults&quot;:true</div>
<div class="line">}</div>
</div><!-- fragment --><p>For example, in the webhooks directory:</p>
<div class="fragment"><div class="line">particle webhook create DeviceNotesGet.json</div>
</div><!-- fragment --><p>If you edit the webhook again, make sure you use <code>particle webhook delete</code> to delete the old one first! The <code>particle webhook create</code> command always creates a new one, even if there is already one with the same event trigger, and both will trigger.</p>
<p>There's also a webhook for the <code>DeviceNotesPut</code> command. You can omit this if you only read data from the cloud and never set the notes from a device.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;event&quot;: &quot;DeviceNotesPut&quot;,</div>
<div class="line">    &quot;url&quot;: &quot;https://api.particle.io/v1/devices/{{PARTICLE_DEVICE_ID}}&quot;,</div>
<div class="line">    &quot;query&quot;: {</div>
<div class="line">        &quot;access_token&quot;: &quot;ab142050967cff79dc6586c82193978b3a62cab9&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;requestType&quot;: &quot;PUT&quot;,</div>
<div class="line">    &quot;json&quot;: {</div>
<div class="line">        &quot;notes&quot;:&quot;{{{PARTICLE_EVENT_VALUE}}}&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;mydevices&quot;: true,</div>
<div class="line">    &quot;noDefaults&quot;:true</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can also enter the webhooks manually into the Console web interface, if you prefer.</p>
<h1>Using the library</h1>
<p>The library examples are the best way to see how to use the library. However, the underlying <a href="https://github.com/rickkas7/JsonParserGeneratorRK">JsonParserGeneratorRK</a> documentation may also be helpful.</p>
<p>There is also the helpful <a href="https://rickkas7.github.io/jsonparser">JSON code generator</a>. Paste your JSON code into the box and click on a row in the parsed output and it will generate the code you need to access that element.</p>
<p>The full <a href="https://rickkas7.github.io/DeviceNotesHelperRK/index.html">DeviceNotesHelperRK library documentation</a> is browsable online.</p>
<h1>Library Examples</h1>
<h2>1-simple</h2>
<p>The 1-simple example shows how to read a single JSON value ("setting") from the cloud at boot. This can easily be extended to other things.</p>
<p>Here's a description of the the code:</p>
<div class="fragment"><div class="line">#include &quot;DeviceNotesHelperRK.h&quot;</div>
<div class="line"> </div>
<div class="line">SYSTEM_THREAD(ENABLED);</div>
<div class="line"> </div>
<div class="line">SerialLogHandler logHandler;</div>
<div class="line"> </div>
<div class="line">DeviceNotesHelper deviceNotesHelper;</div>
</div><!-- fragment --><p>Standard boilerplate stuff. The code works with threading enabled or disabled. The <code>SerialLogHandler</code> is optional to display debugging info to the USB serial port.</p>
<p>It's common to allocate a single <code>DevicesNoteHelper</code> object as a global variable.</p>
<div class="fragment"><div class="line">void setup() {</div>
<div class="line">    // Override settings here</div>
<div class="line">    deviceNotesHelper</div>
<div class="line">        .withBufferSize(1024)   // Allow a JSON object up to 1024 bytes</div>
<div class="line">        .withGetAtBoot();       // Fetch the devices notes once at boot after connecting to the cloud</div>
</div><!-- fragment --><p>You typically configure the <code><a class="el" href="class_device_notes_helper.html">DeviceNotesHelper</a></code> in <code>setup()</code>. In this case, we set the maximum JSON object size (1024 bytes) and get the device notes once at boot. You can also get the data periodically using <code>withGetPeriodic()</code>.</p>
<div class="fragment"><div class="line">deviceNotesHelper.withDataUpdatedCallback([](JsonParser &amp;jp) {</div>
<div class="line">    // This function gets called when the data is updated at boot time. We just print the</div>
<div class="line">    // data here, but you could do something more useful with it.</div>
<div class="line"> </div>
<div class="line">    int setting = 0;</div>
<div class="line">    jp.getValueByKey(jp.getOuterObject(), &quot;setting&quot;, setting);</div>
<div class="line"> </div>
<div class="line">    Log.info(&quot;received setting=%d&quot;, setting);</div>
<div class="line">});</div>
</div><!-- fragment --><p>This is a C++11 lambda. You could put the code in a separate function if you prefer. The important part is that the code inside the { } gets run when the device notes are downloaded from the cloud.</p>
<p>In this example, we get the <code>setting</code> key from the device notes (an int variable) and print it to the serial debug console.</p>
<div class="fragment"><div class="line">    // You must call this from setup!</div>
<div class="line">    deviceNotesHelper.setup();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Make sure you call <code>deviceNotesHelper.setup();</code> from <code>setup()</code>!</p>
<div class="fragment"><div class="line">void loop() {</div>
<div class="line">    // You must call this from loop, preferably every loop but at least every few seconds.</div>
<div class="line">    deviceNotesHelper.loop();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Make sure you call <code>deviceNotesHelper.loop();</code> from <code>loop()</code>!</p>
<h2>2-counter</h2>
<p>The 2-counter example shows how to both get an object from the cloud, as well as update it from the device.</p>
<p>This technique can be used to save a small amount of data from the device in the cloud without needing additional servers or 3rd-party services, even when the device is offline.</p>
<p>For devices that are online all the time, Particle variables might be a better choice.</p>
<p>And at larger scales, having a server that stores the last value from Particle.publish using webhooks or SSE (server sent events) is far more efficient.</p>
<p>The object is limited to the size of a single publish, so 622 bytes.</p>
<p>Still, it's an interesting technique!</p>
<div class="fragment"><div class="line">#include &quot;DeviceNotesHelperRK.h&quot;</div>
<div class="line"> </div>
<div class="line">SYSTEM_THREAD(ENABLED);</div>
<div class="line"> </div>
<div class="line">SerialLogHandler logHandler;</div>
<div class="line"> </div>
<div class="line">DeviceNotesHelper deviceNotesHelper;</div>
</div><!-- fragment --><p>Standard boilerplate stuff. The code works with threading enabled or disabled. The <code>SerialLogHandler</code> is optional to display debugging info to the USB serial port.</p>
<p>It's common to allocate a single <code>DevicesNoteHelper</code> object as a global variable.</p>
<div class="fragment"><div class="line">const unsigned long UPDATE_COUNTER_PERIOD = 60000; // Once a minute</div>
<div class="line">unsigned long lastUpdateCounter = 0;</div>
<div class="line"> </div>
<div class="line">void incrementCounter();</div>
</div><!-- fragment --><p>Some settings we use in our code and a forward declaration of the <code>incrementCounter()</code> function.</p>
<div class="fragment"><div class="line">void setup() {</div>
<div class="line">    // Override settings here</div>
<div class="line">    deviceNotesHelper.withBufferSize(640); // Allow a JSON object up to 640 bytes</div>
<div class="line">    deviceNotesHelper.withGetAtBoot();</div>
</div><!-- fragment --><p>Setting up the configuration. We have a maximum data size of a single publish because we set the data, so 640 bytes. We also get the data at boot.</p>
<div class="fragment"><div class="line">deviceNotesHelper.withDataUpdatedCallback([](JsonParser &amp;jp) {</div>
<div class="line">    // This function gets called when the data is received from the cloud</div>
<div class="line">    lastUpdateCounter = millis();</div>
<div class="line">    incrementCounter();</div>
<div class="line">});</div>
</div><!-- fragment --><p>The code in the { } gets executed whenever the data is received from the cloud. We track when that happened and increment the counter (see below).</p>
<div class="fragment"><div class="line">    // You must call this from setup!</div>
<div class="line">    deviceNotesHelper.setup();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Don't forget to call <code>deviceNotesHelper.setup()</code> from <code>setup()</code>!</p>
<div class="fragment"><div class="line">void loop() {</div>
<div class="line">    if (millis() - lastUpdateCounter &gt;= UPDATE_COUNTER_PERIOD &amp;&amp; Particle.connected()) {</div>
<div class="line">        lastUpdateCounter = millis();</div>
<div class="line"> </div>
<div class="line">        if (!deviceNotesHelper.hasData()) {</div>
<div class="line">            // We didn&#39;t update from the cloud at boot successfully, so try to get data again</div>
<div class="line">            deviceNotesHelper.getFromCloud();</div>
<div class="line">        }</div>
<div class="line">        else {</div>
<div class="line">            // We have saved data, so just increment the value we got last time</div>
<div class="line">            // rather than doing both a get and set</div>
<div class="line">            incrementCounter();</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --><p>This code periodically (every <code>UPDATE_COUNTER_PERIOD</code> milliseconds) while connected to the cloud, increments the counter and saves the value to the device notes.</p>
<div class="fragment"><div class="line">    // You must call this from loop, preferably every loop but at least every few seconds.</div>
<div class="line">    deviceNotesHelper.loop();</div>
<div class="line">}</div>
</div><!-- fragment --><p>Don't forget to call <code>deviceNotesHelper.loop()</code> from <code>loop()</code>!</p>
<div class="fragment"><div class="line">void incrementCounter() {</div>
<div class="line">    JsonParser &amp;jp = deviceNotesHelper.getJsonParser();</div>
<div class="line"> </div>
<div class="line">    int counter = 0;</div>
<div class="line">    jp.getValueByKey(jp.getOuterObject(), &quot;counter&quot;, counter);</div>
<div class="line"> </div>
<div class="line">    JsonModifier mod(jp);</div>
<div class="line">    mod.insertOrUpdateKeyValue(jp.getOuterObject(), &quot;counter&quot;, ++counter);</div>
<div class="line"> </div>
<div class="line">    Log.info(&quot;counter=%d&quot;, counter);</div>
<div class="line"> </div>
<div class="line">    deviceNotesHelper.putToCloud();</div>
<div class="line">}</div>
</div><!-- fragment --><p>This code gets the <code>counter</code> value that we previously got from the cloud and modifies the JSON to increment the value by 1.</p>
<p>Then it uses the <code>deviceNotesHelper.putToCloud()</code> method to put the modified data to the cloud. It does a <code>Particle.publish()</code> which is transformed to a Particle API call by a webhook.</p>
<h2>3-print</h2>
<p>The 3-print example is more or less like 1-simple, but it also shows how to pretty print the entire JSON object. Works with larger objects.</p>
<h1>More about JsonParser</h1>
<p>To decode the JSON data you use the <code>JsonParser</code> object. It's passed into your callback.</p>
<p>Say you have this object:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;t1&quot;:&quot;abc&quot;,</div>
<div class="line">  &quot;t2&quot;:1234,</div>
<div class="line">  &quot;t3&quot;:1234.5,</div>
<div class="line">  &quot;t4&quot;:true,</div>
<div class="line">  &quot;t5&quot;:false,</div>
<div class="line">  &quot;t6&quot;:null,</div>
<div class="line">  &quot;t7&quot;:&quot;\&quot;quoted\&quot;&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>You could read the value of t1 by using <a href="http://rickkas7.github.io/JsonParserGeneratorRK/class_json_parser.html#a38858994342cd2735b716b117bf8afdf">getOuterValueByKey</a> and this code:</p>
<div class="fragment"><div class="line">String strValue;</div>
<div class="line">jp.getOuterValueByKey(&quot;t1&quot;, strValue);</div>
</div><!-- fragment --><p>This also works for other data types:</p>
<div class="fragment"><div class="line">int intValue;</div>
<div class="line">jp.getOuterValueByKey(&quot;t2&quot;, intValue)</div>
<div class="line"> </div>
<div class="line">float floatValue;</div>
<div class="line">jp.getOuterValueByKey(&quot;t3&quot;, floatValue);</div>
<div class="line"> </div>
<div class="line">bool boolValue;</div>
<div class="line">jp.getOuterValueByKey(&quot;t4&quot;, boolValue);</div>
</div><!-- fragment --><p>You can also read values of nested objects, arrays, etc. but you probably won't need to do that with device notes.</p>
<h1>More about JsonModifier</h1>
<p>Assuming your <code>JsonParser</code> is in the variable <code>jp</code> you then construct a temporary modifier object on the stack like this:</p>
<div class="fragment"><div class="line">JsonModifier mod(jp);</div>
</div><!-- fragment --><p>The most common thing to do is have a JSON object and you want to update the value, or insert the value if it does not exist:</p>
<div class="fragment"><div class="line">mod.insertOrUpdateKeyValue(jp.getOuterObject(), &quot;t2&quot;, (int)999);</div>
</div><!-- fragment --><p>If the input JSON was as above, then it would be changed to:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;t1&quot;:&quot;abc&quot;,</div>
<div class="line">  &quot;t3&quot;:1234.5,</div>
<div class="line">  &quot;t4&quot;:true,</div>
<div class="line">  &quot;t5&quot;:false,</div>
<div class="line">  &quot;t6&quot;:null,</div>
<div class="line">  &quot;t7&quot;:&quot;\&quot;quoted\&quot;&quot;,</div>
<div class="line">  &quot;t2&quot;:999</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can add int, long, float, double, bool, and const char * objects this way.</p>
<div class="fragment"><div class="line">mod.insertOrUpdateKeyValue(jp.getOuterObject(), &quot;t1&quot;, &quot;testing&quot;);</div>
</div><!-- fragment --><p>Updating an object will remove it from its current location and add it at the end of the object.</p>
<p>Another common function is <code>appendArrayValue()</code> which appends to an array.</p>
<p>You can also use <code>removeKeyValue()</code> and <code>removeArrayIndex()</code> to remove keys or array entries.</p>
<h1>Updating notes using the Cloud API</h1>
<h2>Using curl</h2>
<p>To get the device notes you get the device information. You must have the device ID (in this example, 1e0032000447343138333038), as well as the access token as described above.</p>
<div class="fragment"><div class="line">curl &quot;https://api.particle.io/v1/devices/1e0032000447343138333038?access_token=$AUTH_TOKEN&quot;</div>
</div><!-- fragment --><p>This returns a JSON object with the device information. In it, you might see this field with the notes set as above. It's the JSON, though it's a string, not actually a JSON object.</p>
<div class="fragment"><div class="line">&quot;notes&quot;:&quot;{\&quot;counter\&quot;:1,\&quot;setting\&quot;:5}&quot;</div>
</div><!-- fragment --><p>To set the value using curl is a bit awkward, but this changes the setting to 6:</p>
<div class="fragment"><div class="line">curl -X PUT -H &quot;Content-Type: application/json&quot; -d &#39;{&quot;notes&quot;:&quot;{\&quot;counter\&quot;:1,\&quot;setting\&quot;:6}&quot;}&#39; &quot;https://api.particle.io/v1/devices/1e0032000447343138333038?access_token=$AUTH_TOKEN&quot;</div>
</div><!-- fragment --><p>When updating the data by curl you must include the whole data, not just the field you want to update. There is a possibility of update conflicts because of this, so this doesn't really take the place of using a proper database.</p>
<h1>Version History</h1>
<h2>0.0.3 (2025-03-17)</h2>
<ul>
<li>Add warning to switch to Ledger</li>
<li>Switch to using a Device ID prefix on the subscription name</li>
</ul>
<h2>0.0.2 (2021-01-07)</h2>
<ul>
<li>Upgrade to JsonParserGeneratorRK 0.1.4</li>
<li>Use addChunked to support out-of-order multipart webhook responses </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
